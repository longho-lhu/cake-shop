<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√™m B√°nh - Cake Shop</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // Auth guard: chuy·ªÉn v·ªÅ login n·∫øu kh√¥ng c√≥ token
        (function () {
            try {
                var token = localStorage.getItem('token');
                if (!token) {
                    window.location.replace('login.html');
                }
            } catch (e) {
                window.location.replace('login.html');
            }
        })();
    </script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">üéÇ Cake Shop</a>
            </div>

            <div class="nav-search">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm b√°nh...">
                <button type="button" id="searchBtn">üîç</button>
            </div>

            <div class="nav-user">
                <div class="user-info" id="userInfo">
                    <img src="" alt="Avatar" id="userAvatar" class="user-avatar">
                    <span id="userName">User</span>
                    <span class="dropdown-icon">‚ñº</span>
                </div>

                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="add-cake.html" class="dropdown-item">
                        <span>‚ûï</span> Th√™m b√°nh
                    </a>
                    <a href="#" class="dropdown-item">
                        <span>‚öôÔ∏è</span> C√†i ƒë·∫∑t
                    </a>
                    <a href="#" class="dropdown-item" id="logoutBtn">
                        <span>üö™</span> ƒêƒÉng xu·∫•t
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="add-cake-header">
            <h1>Th√™m b√°nh m·ªõi üéÇ</h1>
            <a href="index.html" class="btn-back">‚Üê Quay l·∫°i</a>
        </div>

        <form class="add-cake-form" id="addCakeForm">
            <div id="formMessage" class="form-message" style="display: none;"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cakeName">T√™n b√°nh <span class="required">*</span></label>
                    <input type="text" id="cakeName" name="name" placeholder="V√≠ d·ª•: B√°nh sinh nh·∫≠t socola" required>
                </div>

                <div class="form-group">
                    <label for="cakeCategory">Lo·∫°i b√°nh <span class="required">*</span></label>
                    <input type="text" id="cakeCategory" name="category" placeholder="V√≠ d·ª•: socola, kem, tr√°i c√¢y..."
                        required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cakePrice">Gi√° (VNƒê) <span class="required">*</span></label>
                    <input type="number" id="cakePrice" name="price" placeholder="100000" min="0" step="1000" required>
                </div>

                <div class="form-group">
                    <label for="cakeImage">URL h√¨nh ·∫£nh</label>
                    <input type="url" id="cakeImage" name="image" placeholder="https://example.com/cake.jpg">
                </div>
            </div>

            <div class="form-group">
                <label for="cakeDescription">M√¥ t·∫£</label>
                <textarea id="cakeDescription" name="description" rows="4"
                    placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ b√°nh..."></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="window.location.href='index.html'">H·ªßy</button>
                <button type="submit" class="btn-primary" id="submitBtn">Th√™m b√°nh</button>
            </div>
        </form>
    </main>

    <script>
        const API_BASE_URL = 'https://banhngot.fitlhu.com';

        // Hi·ªÉn th·ªã user info
        window.addEventListener('load', function () {
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('userName').textContent = user.full_name || user.username;
                const avatar = user.avatar || 'https://via.placeholder.com/40';
                document.getElementById('userAvatar').src = avatar;
            }
        });

        // Toggle dropdown
        const userInfo = document.getElementById('userInfo');
        const dropdownMenu = document.getElementById('dropdownMenu');

        userInfo.addEventListener('click', function (e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });

        document.addEventListener('click', function () {
            dropdownMenu.classList.remove('show');
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function (e) {
            e.preventDefault();
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        });

        // Search
        document.getElementById('searchBtn').addEventListener('click', function () {
            const searchValue = document.getElementById('searchInput').value;
            if (searchValue.trim()) {
                console.log('T√¨m ki·∫øm:', searchValue);
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // Form handling
        const formMessage = document.getElementById('formMessage');
        const submitBtn = document.getElementById('submitBtn');

        function showMessage(message, type = 'info') {
            formMessage.textContent = message;
            formMessage.className = 'form-message form-message-' + type;
            formMessage.style.display = 'block';
        }

        function hideMessage() {
            formMessage.style.display = 'none';
        }

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Th√™m b√°nh';
            }
        }

        document.getElementById('addCakeForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            hideMessage();

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.replace('login.html');
                return;
            }

            const formData = {
                name: document.getElementById('cakeName').value.trim(),
                category: document.getElementById('cakeCategory').value.trim(),
                price: parseFloat(document.getElementById('cakePrice').value),
                image: document.getElementById('cakeImage').value.trim() || '',
                description: document.getElementById('cakeDescription').value.trim() || ''
            };

            // Validation
            if (!formData.name || !formData.category || !formData.price || formData.price <= 0) {
                showMessage('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc.', 'error');
                return;
            }

            try {
                setLoading(true);

                const response = await fetch(`${API_BASE_URL}/api/cakes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message || 'Th√™m b√°nh th√†nh c√¥ng!', 'success');
                    // Reset form
                    document.getElementById('addCakeForm').reset();
                    // Chuy·ªÉn v·ªÅ trang ch·ªß sau 1.5 gi√¢y
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    showMessage(data.message || 'Kh√¥ng th·ªÉ th√™m b√°nh. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                }
            } catch (error) {
                console.error('Add cake error:', error);
                showMessage('L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>

</html>