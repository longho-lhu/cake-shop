<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cake Shop - Trang Ch·ªß</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // Auth guard: ch·∫°y s·ªõm ngay khi t·∫£i trang ƒë·ªÉ tr√°nh hi·ªÉn th·ªã nh√°y n·ªôi dung
        (function () {
            try {
                var token = localStorage.getItem('token');
                if (!token) {
                    window.location.replace('login.html');
                }
            } catch (e) {
                // B·ªè qua l·ªói truy c·∫≠p storage (v√≠ d·ª•: ch·∫ø ƒë·ªô ri√™ng t∆∞)
                window.location.replace('login.html');
            }
        })();
    </script>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <!-- Logo -->
            <div class="nav-logo">
                <a href="index.html">üéÇ Cake Shop</a>
            </div>

            <!-- Search Bar -->
            <div class="nav-search">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm b√°nh...">
                <button type="button" id="searchBtn">üîç</button>
            </div>

            <!-- User Menu -->
            <div class="nav-user">
                <div class="user-info" id="userInfo">
                    <img src="" alt="Avatar" id="userAvatar" class="user-avatar">
                    <span id="userName">User</span>
                    <span class="dropdown-icon">‚ñº</span>
                </div>

                <!-- Dropdown Menu -->
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="add-cake.html" class="dropdown-item">
                        <span>‚ûï</span> Th√™m b√°nh
                    </a>
                    <a href="#" class="dropdown-item">
                        <span>‚öôÔ∏è</span> C√†i ƒë·∫∑t
                    </a>
                    <a href="#" class="dropdown-item" id="logoutBtn">
                        <span>üö™</span> ƒêƒÉng xu·∫•t
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="cakes-header">
            <h1>B·ªô s∆∞u t·∫≠p b√°nh c·ªßa b·∫°n üéÇ</h1>
            <div class="cakes-toolbar">
                <div id="totalInfo" class="total-info"></div>
            </div>
        </div>

        <div id="cakesStatus" class="cakes-status"></div>

        <div id="cakesGrid" class="cakes-grid" aria-live="polite"></div>

        <div class="pagination" id="pagination" aria-label="Ph√¢n trang b√°nh">
            <button id="prevPage" class="page-btn" disabled aria-label="Trang tr∆∞·ªõc">‚óÄ Tr∆∞·ªõc</button>
            <div id="pageInfo" class="page-info">Trang 1 / 1</div>
            <button id="nextPage" class="page-btn" disabled aria-label="Trang sau">Ti·∫øp ‚ñ∂</button>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'https://banhngot.fitlhu.com';

        // Kh·ªüi t·∫°o hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng (token ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra s·ªõm ·ªü <head>)
        window.addEventListener('load', function () {
            const user = JSON.parse(localStorage.getItem('user'));
            if (user) {
                document.getElementById('userName').textContent = user.full_name || user.username;
                const avatar = user.avatar || 'https://via.placeholder.com/40';
                document.getElementById('userAvatar').src = avatar;
            }
            // T·∫£i danh s√°ch b√°nh l·∫ßn ƒë·∫ßu
            fetchAndRenderCakes(1);
        });

        // ----------------------- Cakes Listing with Pagination -----------------------
        let currentPage = 1;
        const limit = 12; // kho·∫£ng 12 b√°nh m·ªói trang
        let totalPages = 1;

        const cakesGrid = document.getElementById('cakesGrid');
        const cakesStatus = document.getElementById('cakesStatus');
        const totalInfo = document.getElementById('totalInfo');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');

        function formatVND(value) {
            try {
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
            } catch (e) {
                return value + ' VND';
            }
        }

        function setStatus(message, type = 'info') {
            cakesStatus.textContent = message || '';
            cakesStatus.className = 'cakes-status ' + (type ? 'status-' + type : '');
        }

        function renderCakes(cakes) {
            if (!cakes || cakes.length === 0) {
                cakesGrid.innerHTML = '';
                setStatus('B·∫°n ch∆∞a c√≥ b√°nh n√†o. H√£y th√™m chi·∫øc b√°nh ƒë·∫ßu ti√™n c·ªßa b·∫°n!', 'empty');
                return;
            }
            setStatus('');
            const html = cakes.map(c => {
                const img = c.image && typeof c.image === 'string' ? c.image : '';
                const safeImg = img && /^https?:\/\//.test(img) ? img : 'https://via.placeholder.com/400x250?text=Cake';
                const price = typeof c.price === 'number' ? c.price : parseFloat(c.price) || 0;
                return `
                <div class="cake-card">
                    <div class="cake-thumb">
                        <img src="${safeImg}" alt="${c.name || 'B√°nh'}" onerror="this.src='https://via.placeholder.com/400x250?text=Cake'">
                    </div>
                    <div class="cake-body">
                        <h3 class="cake-title" title="${c.name || ''}">${c.name || 'Kh√¥ng t√™n'}</h3>
                        <div class="cake-meta">
                            <span class="cake-category">${c.category || 'kh√°c'}</span>
                            <span class="cake-price">${formatVND(price)}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
            cakesGrid.innerHTML = html;
        }

        function renderPagination(pagination) {
            if (!pagination) return;
            totalPages = Math.max(1, pagination.totalPages || 1);
            currentPage = Math.min(Math.max(1, pagination.page || 1), totalPages);
            pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            // T·ªïng s·ªë
            if (pagination.total != null) {
                totalInfo.textContent = `T·ªïng s·ªë: ${pagination.total} b√°nh`;
            } else {
                totalInfo.textContent = '';
            }
        }

        async function fetchAndRenderCakes(page = 1) {
            const token = localStorage.getItem('token');
            if (!token) {
                // Ph√≤ng h·ªù n·∫øu token thi·∫øu (ƒë√£ c√≥ guard ·ªü <head>)
                window.location.replace('login.html');
                return;
            }

            setStatus('ƒêang t·∫£i d·ªØ li·ªáu...', 'loading');
            cakesGrid.innerHTML = '';

            try {
                const url = new URL(`${API_BASE_URL}/api/cakes/my`);
                url.searchParams.set('page', String(page));
                url.searchParams.set('limit', String(limit));

                const res = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const json = await res.json();
                if (!json.success) {
                    setStatus(json.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√°nh.', 'error');
                    // N·∫øu l·ªói do token, ƒë∆∞a v·ªÅ login
                    if (/token/i.test(json.message || '')) {
                        setTimeout(() => window.location.replace('login.html'), 800);
                    }
                    return;
                }

                renderCakes(json.data || []);
                renderPagination(json.pagination || { page: page, totalPages: 1 });
            } catch (err) {
                console.error('Fetch cakes error:', err);
                setStatus('L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            }
        }

        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                fetchAndRenderCakes(currentPage - 1);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                fetchAndRenderCakes(currentPage + 1);
            }
        });

        // Toggle dropdown menu
        const userInfo = document.getElementById('userInfo');
        const dropdownMenu = document.getElementById('dropdownMenu');

        userInfo.addEventListener('click', function (e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });

        // ƒê√≥ng dropdown khi click b√™n ngo√†i
        document.addEventListener('click', function () {
            dropdownMenu.classList.remove('show');
        });

        // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
        document.getElementById('logoutBtn').addEventListener('click', function (e) {
            e.preventDefault();

            // X√≥a th√¥ng tin t·ª´ localStorage
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');

            // Redirect v·ªÅ trang login
            window.location.href = 'login.html';
        });

        // X·ª≠ l√Ω t√¨m ki·∫øm
        document.getElementById('searchBtn').addEventListener('click', function () {
            const searchValue = document.getElementById('searchInput').value;
            if (searchValue.trim()) {
                console.log('T√¨m ki·∫øm:', searchValue);
                // Th√™m logic t√¨m ki·∫øm ·ªü ƒë√¢y
            }
        });

        // T√¨m ki·∫øm khi nh·∫•n Enter
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });
    </script>
</body>

</html>